# 02 数据库模块审阅（`src/db`）

## 高优先级问题（直接影响业务正确性）

### DB-1. completion 索引非法值被静默改写为 0，可能导致覆盖/错统
- 位置：`src/db/eval_db_repo.py:417-426`
- 问题：`sample_index` / `repeat_index` 转换失败时直接回退为 `0`。
- 风险：
  - 多条异常样本会落在同一个 `(task_id, 0, 0)`，触发 upsert 覆盖。
  - 最终统计样本数和准确率可能明显偏差。
- 建议：
  - 转换失败直接拒绝写入并记录错误（不要兜底为 0）。
  - 增加输入校验层（Pydantic/dataclass validator）。

### DB-2. `insert_eval` 的更新条件过宽，可能批量改写历史 eval 行
- 位置：`src/db/eval_db_repo.py:476-479`
- 问题：存在旧数据时，执行 `update(Eval).where(Eval.completions_id == completions_id)`。
- 风险：若同一 `completions_id` 有多行历史（迁移/脏数据场景），会被一次性全部改写。
- 建议：
  - 给 `eval.completions_id` 建唯一约束，彻底保证一对一。
  - 或只更新 latest `eval_id`（精准更新）。

### DB-3. 缺少关键业务唯一约束，导致“逻辑实体可重复”
- 位置：`src/db/orm.py`（`Benchmark`, `Model`, `Task`）
- 问题：
  - `benchmark_name + benchmark_split` 未唯一。
  - `model_name + arch_version + data_version + num_params` 未唯一。
- 风险：重复实体导致“最新记录”选择依赖时间而非真实主键，易漂移。
- 建议：增加唯一索引，并在 service/repo 层改为 upsert/get-or-create。

## 中优先级问题

### DB-4. `EvalDbService` 存在重复流程实现
- 位置：`src/db/eval_db_service.py:92-241` 与 `src/db/eval_db_service.py:243-341`
- 问题：`get_resume_context+create_task_from_context` 和 `get_or_create_task` 大段重复。
- 影响：后续修复 resume/建 task 逻辑时易出现双轨漂移。
- 建议：合并为单路径 API。

### DB-5. `should_allow_resume` 参数未被使用
- 位置：`src/db/eval_db_service.py:490-516`
- 问题：`is_cot` 形参未参与逻辑。
- 建议：要么删除参数，要么补全 cot 维度判断。

### DB-6. 任务状态回写存在误判窗口
- 位置：多个入口脚本异常分支（例如 `src/bin/eval_free_response.py:229-231`）
- 问题：异常时用 `count_completions == expected_count` 判定 completed，遇到历史已写入数据时可能“异常但判 completed”。
- 建议：
  - 用“本次运行写入计数 + stage 完整性”判定。
  - 或在 task 内记录 `run_attempt_id`，按 attempt 聚合。

## 低优先级问题

### DB-7. 旧测试与现实现已脱节
- 位置：`tests/test_db_integration.py:5`
- 问题：测试依赖已不存在的 `DatabaseManager`，当前 DB 实现已切到 ORM+service。
- 建议：重写集成测试，不再依赖历史 API。

